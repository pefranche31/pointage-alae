<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur Planning ALAE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-5xl mx-auto p-6 md:p-12">
        <header class="mb-12 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-indigo-600 text-white rounded-2xl mb-4 shadow-lg shadow-indigo-200">
                <i data-lucide="refresh-cw" class="w-8 h-8"></i>
            </div>
            <h1 class="text-3xl font-black tracking-tight text-slate-800">Convertisseur Planning ALAE</h1>
            <p class="text-slate-500 mt-2 font-medium">Format 26 colonnes (p-lun-ma, i-ven-so, etc.)</p>
        </header>

        <!-- Zone de téléchargement -->
        <div id="drop-zone" class="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-12 text-center hover:border-indigo-400 hover:bg-indigo-50/30 transition-all cursor-pointer group">
            <input type="file" id="csv-file" accept=".csv" class="hidden">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">
                <i data-lucide="upload-cloud" class="w-8 h-8"></i>
            </div>
            <p class="text-lg font-bold text-slate-700">Cliquez ou glissez votre fichier .csv ici</p>
            <p class="text-xs text-slate-400 mt-2 uppercase font-black tracking-widest">Le fichier doit contenir 26 colonnes</p>
        </div>

        <!-- Section Résultats -->
        <div id="result-section" class="hidden mt-12 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-50 bg-slate-50/50 flex items-center justify-between">
                    <h2 class="font-black uppercase text-xs tracking-widest text-slate-400">Aperçu de l'importation</h2>
                    <span id="child-count" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold"></span>
                </div>
                <div class="overflow-x-auto">
                    <table id="preview-table" class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b">
                            <tr>
                                <th class="p-4">Classe</th>
                                <th class="p-4">Enfant</th>
                                <th class="p-4 text-center">Sem. Paire (L M J V)</th>
                                <th class="p-4 text-center">Sem. Impaire (L M J V)</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-slate-50">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button id="download-btn" class="flex items-center gap-3 bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold shadow-xl shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Générer enfants_alae.json
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('csv-file');
        const resultSection = document.getElementById('result-section');
        const downloadBtn = document.getElementById('download-btn');
        let generatedData = [];

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        };

        function processFile(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    mapDataToStructure(results.data);
                }
            });
        }

        // Mappage des jours et périodes selon vos codes
        const DAYS_MAP = {
            'lun': 'lundi',
            'mar': 'mardi',
            'jeu': 'jeudi',
            'ven': 'vendredi',
            've': 'vendredi' // Gère le cas 'i-ve-mi' mentionné
        };

        const PERIODS_MAP = {
            'ma': 'matin',
            'mi': 'midi',
            'so': 'soir'
        };

        function mapDataToStructure(data) {
            const children = data.map((row, index) => {
                const keys = Object.keys(row);
                
                // Colonne 1 : Classe
                // Colonne 2 : Nom Prenom
                const classe = row[keys[0]] || "Sans classe";
                const fullName = row[keys[1]] || "Enfant Inconnu";
                
                // Niveau auto
                const level = (classe.startsWith('1') || classe.startsWith('2')) ? 'Maternelle' : 'Élémentaire';

                // Séparation Nom / Prénom
                const parts = fullName.trim().split(' ');
                const nom = parts[0] ? parts[0].toUpperCase() : "NOM";
                const prenom = parts.slice(1).join(' ') || "Prénom";

                // Construction des plannings
                const planning = {
                    paire: extractPlanning(row, 'p-'),
                    impaire: extractPlanning(row, 'i-')
                };

                return {
                    id: String(index + 1),
                    nom,
                    prenom,
                    classe,
                    niveau: level,
                    planning
                };
            });

            generatedData = children;
            displayPreview(children);
        }

        function extractPlanning(row, prefix) {
            const days = ['lundi', 'mardi', 'jeudi', 'vendredi'];
            const p = {};
            
            days.forEach(day => {
                p[day] = {
                    matin: checkCell(row, prefix, day, 'ma'),
                    midi: checkCell(row, prefix, day, 'mi'),
                    soir: checkCell(row, prefix, day, 'so')
                };
            });
            return p;
        }

        function checkCell(row, prefix, dayName, periodCode) {
            // On cherche une clé qui commence par prefix, contient le début du jour et finit par periodCode
            // Ex: 'p-lun-ma'
            const dayShort = dayName.substring(0, 3);
            const keys = Object.keys(row);
            
            const targetKey = keys.find(k => {
                const lowerK = k.toLowerCase();
                return lowerK.startsWith(prefix) && 
                       (lowerK.includes(dayShort) || (dayShort === 'ven' && lowerK.includes('-ve-'))) &&
                       lowerK.endsWith(periodCode);
            });

            if (!targetKey) return false;
            
            const val = String(row[targetKey]).toLowerCase().trim();
            return val === 'x' || val === '1' || val === 'oui' || val === 'p';
        }

        function displayPreview(children) {
            const tbody = document.querySelector('#preview-table tbody');
            tbody.innerHTML = '';
            
            children.slice(0, 15).forEach(c => {
                const tr = document.createElement('tr');
                
                const renderDots = (week) => {
                    const days = ['lundi', 'mardi', 'jeudi', 'vendredi'];
                    return `<div class="flex justify-center gap-2">
                        ${days.map(d => `
                            <div class="flex flex-col gap-0.5">
                                <div class="w-1.5 h-1.5 rounded-full ${c.planning[week][d].matin ? 'bg-indigo-500' : 'bg-slate-100'}"></div>
                                <div class="w-1.5 h-1.5 rounded-full ${c.planning[week][d].midi ? 'bg-amber-500' : 'bg-slate-100'}"></div>
                                <div class="w-1.5 h-1.5 rounded-full ${c.planning[week][d].soir ? 'bg-slate-800' : 'bg-slate-100'}"></div>
                            </div>
                        `).join('<div class="w-px h-4 bg-slate-100 mx-1"></div>')}
                    </div>`;
                };

                tr.innerHTML = `
                    <td class="p-4 font-bold text-slate-700 text-xs">${c.classe}</td>
                    <td class="p-4">
                        <div class="font-black uppercase text-xs text-slate-800">${c.nom} ${c.prenom}</div>
                    </td>
                    <td class="p-4">${renderDots('paire')}</td>
                    <td class="p-4">${renderDots('impaire')}</td>
                `;
                tbody.appendChild(tr);
            });

            if (children.length > 15) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="p-6 text-center text-slate-400 italic text-xs bg-slate-50/50">... + ${children.length - 15} autres enfants chargés</td>`;
                tbody.appendChild(tr);
            }

            document.getElementById('child-count').textContent = `${children.length} enfants trouvés`;
            resultSection.classList.remove('hidden');
            lucide.createIcons();
        }

        downloadBtn.onclick = () => {
            const blob = new Blob([JSON.stringify(generatedData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "enfants_alae.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>