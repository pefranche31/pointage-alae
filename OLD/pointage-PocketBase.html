<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage ALAE - Cloud Sync</title>
    <!-- Bibliothèques React, Tailwind et Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .sticky-col { position: sticky; left: 0; z-index: 20; background-color: white; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, query, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration Firebase via les variables d'environnement
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'alae-default-app';

        // Activation de la persistance hors-ligne (Critique pour le suivi de l'effectif sans réseau)
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code === 'failed-precondition') {
                console.warn("La persistance ne peut être activée que dans un seul onglet à la fois.");
            } else if (err.code === 'unimplemented') {
                console.warn("Le navigateur actuel ne supporte pas la persistance hors-ligne.");
            }
        });

        const { useState, useEffect, useMemo, useRef } = React;

        const CRENEAUX = [
            { id: 'matin', label: 'Mat.' },
            { id: 'midi', label: 'Midi' },
            { id: 'soir', label: 'Soir' }
        ];
        const DAYS = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

        const Icon = ({ name, className }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({ root: iconRef.current, attrs: { class: className || "w-4 h-4" } });
                }
            }, [name, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [children, setChildren] = useState([]);
            const [attendance, setAttendance] = useState({});
            const [locks, setLocks] = useState({});
            const [initializedDates, setInitializedDates] = useState([]);
            
            const [activeTab, setActiveTab] = useState('appel');
            const [selectedClass, setSelectedClass] = useState('Toutes');
            const [currentTime, setCurrentTime] = useState(new Date());
            
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [passwordInput, setPasswordInput] = useState("");
            const [passwordError, setPasswordError] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().substring(0, 7));

            const fileInputRef = useRef(null);

            // --- AUTHENTIFICATION ---
            useEffect(() => {
                const initAuth = async () => {
                    await signInAnonymously(auth);
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                
                const handleStatusChange = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', handleStatusChange);
                window.addEventListener('offline', handleStatusChange);

                return () => {
                    unsubscribe();
                    window.removeEventListener('online', handleStatusChange);
                    window.removeEventListener('offline', handleStatusChange);
                };
            }, []);

            // --- SYNCHRONISATION CLOUD ---
            useEffect(() => {
                if (!user) return;

                const unsubChildren = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'children'), 
                    (snap) => setChildren(snap.docs.map(d => d.data())),
                    (err) => console.error("Erreur de synchro enfants:", err)
                );

                const unsubAttendance = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                    (snap) => {
                        const data = {};
                        snap.docs.forEach(d => data[d.id] = d.data().status);
                        setAttendance(data);
                    }
                );

                const unsubLocks = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'locks'), 
                    (snap) => {
                        const data = {};
                        snap.docs.forEach(d => data[d.id] = d.data().locked);
                        setLocks(data);
                    }
                );

                return () => {
                    unsubChildren();
                    unsubAttendance();
                    unsubLocks();
                };
            }, [user]);

            // --- LOGIQUE MÉTIER ---
            const dateKey = useMemo(() => currentTime.toLocaleDateString('fr-FR'), [currentTime]);
            
            const fullDate = useMemo(() => {
                return currentTime.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }, [currentTime]);

            const isEvenWeek = useMemo(() => {
                const d = new Date(currentTime);
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7) % 2 === 0;
            }, [currentTime]);

            const isToday = currentTime.toDateString() === new Date().toDateString();

            const isExpected = (child, creneauId) => {
                const weekKey = isEvenWeek ? 'paire' : 'impaire';
                const dayKey = DAYS[currentTime.getDay()].toLowerCase();
                return child.planning?.[weekKey]?.[dayKey]?.[creneauId] === true;
            };

            const getCurrentPeriod = () => {
                const hours = currentTime.getHours();
                const minutes = currentTime.getMinutes();
                const total = hours * 60 + minutes;
                if (total < 9 * 60 + 30) return 'matin';
                if (total < 15 * 60) return 'midi';
                return 'soir';
            };

            // Remplissage automatique des présences prévues (uniquement si en ligne et autorisé)
            useEffect(() => {
                if (user && !initializedDates.includes(dateKey) && isOnline && children.length > 0) {
                    const initPresences = async () => {
                        const batch = writeBatch(db);
                        let changes = false;
                        children.forEach(child => {
                            ['midi', 'soir'].forEach(crId => {
                                const key = `${dateKey}-${child.id}-${crId}`;
                                if (isExpected(child, crId) && !attendance[key]) {
                                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', key), {
                                        status: 'present',
                                        updatedAt: new Date().toISOString()
                                    });
                                    changes = true;
                                }
                            });
                        });
                        if (changes) {
                            try {
                                await batch.commit();
                                setInitializedDates(prev => [...prev, dateKey]);
                            } catch (e) { console.error("Erreur init auto:", e); }
                        } else {
                            setInitializedDates(prev => [...prev, dateKey]);
                        }
                    };
                    initPresences();
                }
            }, [dateKey, children, user, isOnline]);

            const toggleAttendance = async (childId, creneauId, childClass) => {
                if (!isOnline || locks[`${dateKey}-${childClass}-${creneauId}`]) return;
                const key = `${dateKey}-${childId}-${creneauId}`;
                const nextStatus = attendance[key] === 'present' ? null : 'present';
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', key), {
                        status: nextStatus,
                        updatedAt: new Date().toISOString()
                    });
                } catch (e) { console.error("Erreur toggle:", e); }
            };

            const handleDateChange = (e) => {
                const selected = new Date(e.target.value);
                const now = new Date();
                if (selected.toDateString() === now.toDateString()) {
                    setCurrentTime(now);
                } else {
                    setCurrentTime(selected);
                }
            };

            const handleImportJson = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data)) {
                            const batch = writeBatch(db);
                            data.forEach(c => {
                                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'children', c.id);
                                batch.set(ref, {
                                    ...c,
                                    niveau: c.niveau || (c.classe.startsWith('1') || c.classe.startsWith('2') ? 'Maternelle' : 'Élémentaire')
                                });
                            });
                            await batch.commit();
                            alert("Importation réussie.");
                        }
                    } catch (err) { alert("Format JSON invalide."); }
                };
                reader.readAsText(file);
            };

            const exportBillingCsv = () => {
                const [year, month] = exportMonth.split('-').map(Number);
                const first = new Date(year, month - 1, 1);
                const last = new Date(year, month, 0);
                const worked = [];
                for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                    if ([1,2,4,5].includes(d.getDay())) worked.push(new Date(d).toLocaleDateString('fr-FR'));
                }
                let csv = "Nom;Prenom;Classe;";
                worked.forEach(d => { csv += `${d} Mat;${d} Midi;${d} Soir;`; });
                csv += "\n";
                children.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(c => {
                    csv += `${c.nom};${c.prenom};${c.classe};`;
                    worked.forEach(d => {
                        ['matin','midi','soir'].forEach(s => {
                            csv += (attendance[`${d}-${c.id}-${s}`] === 'present' ? "x;" : ";");
                        });
                    });
                    csv += "\n";
                });
                const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `alae_facturation_${exportMonth}.csv`;
                a.click();
                setShowExportModal(false);
            };

            const filteredChildren = useMemo(() => {
                return children
                    .filter(c => {
                        if (selectedClass === 'Toutes') return true;
                        if (selectedClass === 'Maternelle') return c.niveau === 'Maternelle';
                        if (selectedClass === 'Élémentaire') return c.niveau === 'Élémentaire';
                        return c.classe === selectedClass;
                    })
                    .sort((a, b) => a.nom.localeCompare(b.nom));
            }, [children, selectedClass]);

            const dashboardStats = useMemo(() => {
                const period = getCurrentPeriod();
                const inSession = children.filter(c => attendance[`${dateKey}-${c.id}-${period}`] === 'present');
                return {
                    period,
                    total: inSession.length
                };
            }, [children, attendance, dateKey, currentTime]);

            // --- RENDU ---
            return (
                <div className="min-h-screen flex flex-col max-w-2xl mx-auto bg-white shadow-xl relative text-slate-800">
                    
                    {!isOnline && (
                        <div className="bg-red-600 text-white text-[10px] font-black uppercase text-center py-2 sticky top-0 z-[60] flex items-center justify-center gap-2">
                            <Icon name="wifi-off" className="w-3 h-3" />
                            Mode Hors-Ligne — Données Locales
                        </div>
                    )}

                    <header className="bg-white border-b px-4 py-3 flex items-center justify-between sticky top-0 z-40">
                        <div className="flex-1 flex flex-col items-start gap-1">
                            <div className="flex items-center gap-2">
                                <h1 className={`text-lg font-bold ${isToday ? 'text-blue-600' : 'text-orange-600'}`}> Pointage Cloud</h1>
                                {isOnline && <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" title="Synchro active"></div>}
                            </div>
                            <span className="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none">Sem. {isEvenWeek ? 'Paire' : 'Impaire'}</span>
                        </div>
                        
                        <div className="flex-1 flex flex-col items-center">
                            <span className="text-[13px] font-bold text-slate-800 text-center italic leading-tight capitalize">{fullDate}</span>
                            <div className="relative mt-1 group">
                                <input type="date" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onChange={handleDateChange} />
                                <div className="p-1.5 bg-slate-50 text-slate-400 rounded-full border border-slate-100"><Icon name="calendar" className="w-3.5 h-3.5" /></div>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col items-end gap-1.5">
                            <div className="flex gap-1">
                                <button onClick={() => setShowPasswordModal(true)} className="p-1.5 bg-slate-100 text-slate-400 rounded-lg hover:text-indigo-600 border border-slate-200"><Icon name="folder-up" className="w-4 h-4" /></button>
                                <button onClick={() => setShowExportModal(true)} className="p-1.5 bg-slate-100 text-slate-400 rounded-lg hover:text-emerald-600 border border-slate-200"><Icon name="folder-down" className="w-4 h-4" /></button>
                            </div>
                            <div className={`px-3 py-0.5 rounded-lg text-white text-[10px] font-bold ${isToday ? 'bg-blue-600' : 'bg-orange-600'}`}>
                                {filteredChildren.length} Enfants
                            </div>
                        </div>
                    </header>

                    <nav className={`bg-white border-b flex sticky z-30 ${!isOnline ? 'top-[34px]' : 'top-[73px]'}`}>
                        <button onClick={() => setActiveTab('appel')} className={`flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${activeTab === 'appel' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-400'}`}>Appel</button>
                        <button disabled={!isToday} onClick={() => isToday && setActiveTab('dashboard')} className={`flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${!isToday ? 'opacity-20 grayscale cursor-not-allowed' : (activeTab === 'dashboard' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-400')}`}>Dashboard</button>
                    </nav>

                    <main className="flex-1 bg-white pb-20">
                        {activeTab === 'appel' ? (
                            <React.Fragment>
                                <div className="bg-gray-50 border-b p-2 overflow-x-auto no-scrollbar flex gap-2 sticky top-[120px] z-30">
                                    {['Toutes', 'Maternelle', 'Élémentaire'].map(f => (
                                        <button key={f} onClick={() => setSelectedClass(f)} className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase transition-all ${selectedClass === f ? 'bg-slate-800 text-white' : 'bg-white border text-slate-500'}`}>{f}</button>
                                    ))}
                                </div>

                                <table className="w-full border-collapse table-fixed">
                                    <thead>
                                        <tr className="bg-slate-100 border-b text-slate-600 text-[10px] font-black uppercase tracking-wider sticky top-[161px] z-30">
                                            <th className="w-2/5 p-3 text-left sticky-col bg-slate-100">Enfant</th>
                                            {CRENEAUX.map(cr => <th key={cr.id} className="p-3 text-center">{cr.label}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredChildren.map(child => (
                                            <tr key={child.id} className="border-b odd:bg-white even:bg-gray-50/50">
                                                <td className="px-3 py-2 sticky-col border-r shadow-sm">
                                                    <div className="flex flex-col">
                                                        <span className="text-xs font-black uppercase truncate">{child.nom}</span>
                                                        <span className="text-[9px] text-slate-400 truncate">{child.prenom}</span>
                                                        <span className="text-[8px] font-bold text-slate-300 uppercase">{child.classe}</span>
                                                    </div>
                                                </td>
                                                {CRENEAUX.map(cr => {
                                                    const key = `${dateKey}-${child.id}-${cr.id}`;
                                                    const status = attendance[key];
                                                    const locked = locks[`${dateKey}-${child.classe}-${cr.id}`];
                                                    return (
                                                        <td key={cr.id} onClick={() => toggleAttendance(child.id, cr.id, child.classe)} className={`p-0 text-center border-r last:border-r-0 ${locked ? 'bg-slate-50 opacity-40' : 'cursor-pointer hover:bg-blue-50'}`}>
                                                            <div className="flex items-center justify-center min-h-[48px]">
                                                                {status === 'present' ? <Icon name="check-circle" className="w-6 h-6 text-green-500" /> : <div className="w-6 h-6 rounded-md border-2 border-slate-200"></div>}
                                                            </div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </React.Fragment>
                        ) : (
                            <div className="p-6 space-y-6">
                                <h2 className="font-bold flex items-center gap-2"><Icon name="bar-chart-3" className="text-blue-600" /> Effectifs du jour</h2>
                                <div className="bg-blue-50 border border-blue-100 p-8 rounded-3xl text-center shadow-inner">
                                    <span className="text-6xl font-black text-blue-600">{dashboardStats.total}</span>
                                    <p className="text-xs font-bold uppercase text-blue-400 mt-2 tracking-widest">Enfants présents ({dashboardStats.period})</p>
                                </div>
                            </div>
                        )}
                        {children.length === 0 && <div className="p-20 text-center text-slate-300 italic text-sm">Aucune donnée. Importez un fichier via le menu Administrateur.</div>}
                    </main>

                    {/* Modal Password */}
                    {showPasswordModal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white rounded-2xl w-full max-w-xs p-6 shadow-2xl animate-in zoom-in duration-200">
                                <h3 className="font-bold mb-4 flex items-center gap-2 text-indigo-600"><Icon name="lock" /> Administrateur</h3>
                                <input type="password" value={passwordInput} onChange={(e) => { setPasswordInput(e.target.value); setPasswordError(false); }} onKeyPress={(e) => e.key === 'Enter' && (passwordInput === 'ALAE_2026' ? (setShowPasswordModal(false), setPasswordInput(''), fileInputRef.current.click()) : setPasswordError(true))} placeholder="Mot de passe" className="w-full p-3 border rounded-xl mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-100" autoFocus />
                                {passwordError && <p className="text-[10px] text-red-500 mb-4 font-bold">Code incorrect</p>}
                                <div className="flex gap-2"><button onClick={() => setShowPasswordModal(false)} className="flex-1 p-2 text-slate-400 font-bold text-sm bg-slate-50 rounded-xl">Annuler</button><button onClick={() => passwordInput === 'ALAE_2026' ? (setShowPasswordModal(false), setPasswordInput(''), fileInputRef.current.click()) : setPasswordError(true)} className="flex-1 p-2 bg-indigo-600 text-white font-bold rounded-xl text-sm">Valider</button></div>
                                <input type="file" ref={fileInputRef} accept=".json" onChange={handleImportJson} className="hidden" />
                            </div>
                        </div>
                    )}

                    {/* Modal Export */}
                    {showExportModal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-in zoom-in duration-200">
                                <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-slate-800 text-lg flex items-center gap-2"><Icon name="download" className="text-emerald-600" /> Exportation</h3><button onClick={() => setShowExportModal(false)} className="text-slate-300 hover:text-slate-500 transition-colors"><Icon name="x" className="w-6 h-6" /></button></div>
                                <div className="space-y-4">
                                    <button onClick={() => {
                                        const blob = new Blob([JSON.stringify({ type: 'ALAE_FULL_BACKUP', data: { children, attendance, locks, initializedDates } }, null, 2)], {type: "application/json"});
                                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `alae_backup_${dateKey.replace(/\//g, '-')}.json`; a.click();
                                        setShowExportModal(false);
                                    }} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-left hover:border-indigo-300 hover:bg-indigo-50 transition-all">
                                        <div className="font-bold text-sm text-slate-700">Sauvegarde Totale (.json)</div>
                                        <div className="text-[10px] text-slate-400 mt-1">Export complet de l'état actuel de l'application.</div>
                                    </button>
                                    <div className="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                                        <div className="font-bold text-sm text-slate-700 mb-3">Rapport Facturation (.csv)</div>
                                        <input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-2 border border-slate-200 rounded-xl text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-emerald-100" />
                                        <button onClick={exportBillingCsv} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold text-xs shadow-md shadow-emerald-50 hover:bg-emerald-700 transition-colors">Générer le fichier CSV</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>